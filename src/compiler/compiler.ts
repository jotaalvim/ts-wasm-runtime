import { WASMModule } from "../wasm-vm/wasm-code"
import { ASTModule } from "../wat-parser/module"
import { NumberValue, ValType } from "../wat-parser/types"
import { Int32 } from "../number/Int32"
import { replaceIdentifiers } from "./precompile"

export const numberValue = (type: ValType, value: string): NumberValue => {
  switch (type) {
    case ValType.i32:
      return { [type]: value }
    case ValType.i64:
      return { [type]: value }
    case ValType.f32:
      return { [type]: value }
    case ValType.f64:
      return { [type]: value }
  }
}

// Compiles AST generated by wat-parser.ts into machine code for wasm-vm.ts.
export const compile = (ast: ASTModule): WASMModule => {
  ast = replaceIdentifiers(ast)

  // TODO: functions 以外を実装

  const functions = ast.functions.map(fn => ({
    export: fn.export,
    results: fn.results,
    identifier: fn.identifier,
    locals: fn.locals.map(l => l.type),
    parameters: fn.parameters.map(p => p.type),
    code: fn.body
  }))

  const table: { [key: number]: number } = {}
  ast.elems.forEach(e => {
    const offset = Int32.obj(e.offset).toNumber()
    e.funcIds.forEach((id, i) => {
      table[offset + i] = id as number
    })
  })

  return {
    functions,
    table
  }
}
